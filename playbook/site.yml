---
# Play clickhouse installation
- name: Install clickhouse
  hosts: clickhouse
  handlers:
    - name: Start clickhouse service
      become: true
      ansible.builtin.service:
        name: clickhouse-server
        state: restarted

  tasks:
    - name: Get clickhouse distrib
      block:
        - name: Get clickhouse distrib
          ansible.builtin.get_url:
            url: "https://packages.clickhouse.com/rpm/stable/{{ item }}-{{ clickhouse_version }}.noarch.rpm"
            dest: "./{{ item }}-{{ clickhouse_version }}.rpm"
            mode: '0776'
          with_items: "{{ clickhouse_packages }}"
          tags:
            - get_clickhouse
      rescue:
        - name: Get clickhouse distrib (common-static package)
          ansible.builtin.get_url:
            url: "https://packages.clickhouse.com/rpm/stable/clickhouse-common-static-{{ clickhouse_version }}.x86_64.rpm"
            dest: "./clickhouse-common-static-{{ clickhouse_version }}.rpm"
            mode: '0776'
          tags:
            - get_clickhouse

    - name: Install clickhouse packages
      become: true
      ansible.builtin.yum:
        name:
          - yum-utils
          - clickhouse-common-static-{{ clickhouse_version }}.rpm
          - clickhouse-client-{{ clickhouse_version }}.rpm
          - clickhouse-server-{{ clickhouse_version }}.rpm
      tags:
        - install_clickhouse
      notify: Start clickhouse service

    - name: Generate users config
      ansible.builtin.template:
        src: clickhouse.users.j2
        dest: "{{ clickhouse_path_configdir }}/users.d/users.xml"
        owner: "clickhouse"
        group: "clickhouse"
        mode: "0775"
      become: true
      tags:
        - configure_clickhouse

    - name: Generate server config
      ansible.builtin.template:
        src: clickhouse.config.j2
        dest: "{{ clickhouse_path_configdir }}/config.d/config.xml"
        owner: "clickhouse"
        group: "clickhouse"
        mode: "0775"
      become: true
      tags:
        - configure_clickhouse

    - name: Flush handlers
      ansible.builtin.meta: flush_handlers
      tags:
        - install_clickhouse

    - name: Create database and table
      ansible.builtin.shell: |
        clickhouse-client -q "create user vector identified with sha256_password by 'vector';"
        clickhouse-client -q 'create database if not exists logs;'
        clickhouse-client -q 'grant all on logs.* to vector with grant option;'
        clickhouse-client -q 'create table if not exists logs.vector_logs ("file" String, "host" String, "message" String, "date" DateTime) Engine=Log;'
        exit 0
      register: create_db
      failed_when: create_db.rc != 0 and create_db.rc !=82
      changed_when: create_db.rc == 0
      tags:
        - configure_clickhouse

# Play vector installation
- name: Install vector
  hosts: vector
  handlers:
    - name: Start vector service
      become: true
      become_method: sudo
      ansible.builtin.service:
        name: vector
        state: restarted
        daemon_reload: true

  tasks:
    - name: Install vector package | Debian
      become: true
      become_method: sudo
      ansible.builtin.apt:
        deb: "https://packages.timber.io/vector/{{ vector_version }}/{{ vector_package }}_{{ vector_version }}-1_{{ vector_architecture }}.deb"
      tags:
        - install_vector

    - name: Configure service | Template systemd unit
      become: true
      become_method: sudo
      ansible.builtin.template:
        src: vector.service.j2
        dest: /etc/systemd/system/vector.service
        mode: 0644
      tags:
        - configure_vector

    - name: Configure Vector | ensure that directory exists
      become: true
      become_method: sudo
      ansible.builtin.file:
        path: "{{ vector_config_dir }}"
        state: directory
        mode: 0755
      tags:
        - configure_vector

    - name: Configure Vector | Template config
      become: true
      become_method: sudo
      ansible.builtin.template:
        src: vector.yml.j2
        mode: 0755
        dest: "{{ vector_config_dir }}/vector.yml"
      tags:
        - configure_vector
      changed_when: true
      notify: Start vector service

    - name: Flush handlers
      ansible.builtin.meta: flush_handlers
      tags:
        - configure_vector,install_vector
